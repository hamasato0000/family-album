// Prisma schema derived from existing Postgres schema defined in docker/init/01_schema.sql
// NOTE: We will use "db" provider and shadow database approach later for migration diffing against manual SQL.
// For now, models reflect current tables. ENUMs mapped. Relations explicit.

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum content_type {
  image
  video
}

enum user_role {
  owner
  admin
  member
}

enum news_type {
  upload
  comment
}

enum upload_status {
  pending
  uploaded
  failed
  expired
}

// Reference tables (r_ prefix) and event tables (e_ prefix)
// Identity columns -> BigInt @id @default(autoincrement())

model r_gender {
  gender_id   BigInt @id @default(autoincrement())
  gender_name String @db.VarChar(10)
  created_at  DateTime @default(now()) @db.Timestamptz
  updated_at  DateTime @default(now()) @db.Timestamptz

  // children
  r_children r_children[]
}

model r_users {
  user_id      BigInt @id @default(autoincrement())
  idp_user_id  String @unique
  email        String @unique @db.Citext
  display_name String
  created_at   DateTime @default(now()) @db.Timestamptz
  updated_at   DateTime @default(now()) @db.Timestamptz

  // relations
  r_users_albums r_users_albums[]
  e_uploads      e_uploads[] @relation("userUploads")
  e_comments     e_comments[] @relation("authorComments")
}

model r_albums {
  album_id   BigInt @id @default(autoincrement())
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @default(now()) @db.Timestamptz

  r_users_albums r_users_albums[]
  e_news         e_news[]
  r_children     r_children[]
  r_contents     r_contents[]
}

model r_child_relations {
  child_relation_id BigInt @id @default(autoincrement())
  relation_name     String @db.VarChar(20)
  created_at        DateTime @default(now()) @db.Timestamptz
  updated_at        DateTime @default(now()) @db.Timestamptz
  // NOTE: In SQL design r_users_albums stores child_relation as plain text; we keep table for master data only.
}

model r_users_albums {
  user_album_id  BigInt @id @default(autoincrement())
  user_id        BigInt
  album_id       BigInt
  role           user_role @default(member)
  child_relation String @db.VarChar(20)
  nickname       String @db.VarChar(50)
  joined_at      DateTime @default(now()) @db.Timestamptz
  created_at     DateTime @default(now()) @db.Timestamptz
  updated_at     DateTime @default(now()) @db.Timestamptz

  r_users  r_users  @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  r_albums r_albums @relation(fields: [album_id], references: [album_id], onDelete: Cascade)

  @@unique([user_id, album_id], map: "idx_users_albums_user_album")
}

model e_news {
  news_id    BigInt @id @default(autoincrement())
  album_id   BigInt
  news_type  news_type
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @default(now()) @db.Timestamptz

  r_albums r_albums @relation(fields: [album_id], references: [album_id])
  e_uploads  e_uploads?
  e_comments e_comments?
}

model e_uploads {
  upload_id    BigInt @id // references e_news(news_id) 1:1 share PK
  uploader_id  BigInt
  photo_count  BigInt @default(0)
  video_count  BigInt @default(0)
  created_at   DateTime @default(now()) @db.Timestamptz
  updated_at   DateTime @default(now()) @db.Timestamptz

  e_news   e_news   @relation(fields: [upload_id], references: [news_id], onDelete: Cascade)
  r_users  r_users  @relation("userUploads", fields: [uploader_id], references: [user_id])
  r_contents r_contents[]
}

model r_contents {
  content_id    BigInt @id @default(autoincrement())
  album_id      BigInt
  upload_id     BigInt
  content_type  content_type
  content_hash  String @unique @db.Char(64)
  uri           String? @unique
  storage_key   String @unique
  caption       String?
  taken_at      DateTime? @db.Timestamptz
  created_at    DateTime @default(now()) @db.Timestamptz
  updated_at    DateTime @default(now()) @db.Timestamptz

  r_albums  r_albums  @relation(fields: [album_id], references: [album_id])
  e_uploads e_uploads @relation(fields: [upload_id], references: [upload_id])
  r_photos  r_photos?
  r_videos  r_videos?
  e_comments e_comments[]
}

model r_photos {
  photo_id   BigInt @id // references r_contents(content_id)
  width      BigInt
  height     BigInt
  exif       Json?
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @default(now()) @db.Timestamptz

  r_contents r_contents @relation(fields: [photo_id], references: [content_id], onDelete: Cascade)
}

model r_videos {
  video_id   BigInt @id // references r_contents(content_id)
  duration_seconds BigInt
  metadata   Json?
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @default(now()) @db.Timestamptz

  r_contents r_contents @relation(fields: [video_id], references: [content_id], onDelete: Cascade)
}

model e_comments {
  comment_id  BigInt @id // references e_news(news_id)
  content_id  BigInt
  author_id   BigInt?
  body        String
  posted_at   DateTime @default(now()) @db.Timestamptz
  edited_at   DateTime @default(now()) @db.Timestamptz
  created_at  DateTime @default(now()) @db.Timestamptz
  updated_at  DateTime @default(now()) @db.Timestamptz

  e_news     e_news     @relation(fields: [comment_id], references: [news_id], onDelete: Cascade)
  r_contents r_contents @relation(fields: [content_id], references: [content_id], onDelete: Cascade)
  r_users    r_users?   @relation("authorComments", fields: [author_id], references: [user_id], onDelete: SetNull)
}

model r_children {
  child_id   BigInt @id @default(autoincrement())
  album_id   BigInt
  name       String
  birthday   DateTime? @db.Date
  gender_id  BigInt
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @default(now()) @db.Timestamptz

  r_albums r_albums @relation(fields: [album_id], references: [album_id])
  r_gender r_gender @relation(fields: [gender_id], references: [gender_id])
}

model e_upload_sessions {
  upload_session_id BigInt @id @default(autoincrement())
  object_key        String @unique
  upload_status     upload_status @default(pending)
  expected_content_type String?
  max_bytes         Int?
  presigned_url     String
  expires_at        DateTime @db.Timestamptz
  created_at        DateTime @default(now()) @db.Timestamptz
  updated_at        DateTime @default(now()) @db.Timestamptz
}
