generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums ---
enum ContentType {
  image
  video

  @@map("content_type")
}

enum UserRole {
  owner
  admin
  member

  @@map("user_role")
}

enum NewsType {
  upload
  comment

  @@map("news_type")
}

enum UploadStatus {
  pending
  uploaded
  failed
  expired

  @@map("upload_status")
}

// --- Models ---
// モデル名を PascalCase、テーブル名を @@map で指定
// フィールド名を camelCase、カラム名を @map で指定
// リレーションフィールド名からプレフィックスを除去

model RGender {
  genderId   BigInt   @id @default(autoincrement()) @map("gender_id")
  genderName String   @db.VarChar(10) @map("gender_name")
  createdAt  DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt  DateTime @default(now()) @db.Timestamptz @map("updated_at")

  children RChildren[] @relation("GenderChildren")

  @@map("r_gender")
}

model RUsers {
  userId      BigInt   @id @default(autoincrement()) @map("user_id")
  idpUserId   String   @unique @map("idp_user_id")
  email       String   @unique @db.Citext
  displayName String   @map("display_name")
  createdAt   DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt   DateTime @default(now()) @db.Timestamptz @map("updated_at")

  usersAlbums RUsersAlbums[] @relation("UserAlbums")
  uploads     EUploads[]     @relation("UserUploads")
  comments    EComments[]    @relation("AuthorComments")

  @@map("r_users")
}

model RAlbums {
  albumId   BigInt   @id @default(autoincrement()) @map("album_id")
  createdAt DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt DateTime @default(now()) @db.Timestamptz @map("updated_at")

  usersAlbums RUsersAlbums[] @relation("AlbumUsers")
  news        ENews[]
  children    RChildren[]
  contents    RContents[]

  @@map("r_albums")
}

model RChildRelations {
  childRelationId BigInt   @id @default(autoincrement()) @map("child_relation_id")
  relationName    String   @db.VarChar(20) @map("relation_name")
  createdAt       DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt       DateTime @default(now()) @db.Timestamptz @map("updated_at")

  @@map("r_child_relations")
}

model RUsersAlbums {
  userAlbumId   BigInt   @id @default(autoincrement()) @map("user_album_id")
  userId        BigInt   @map("user_id")
  albumId       BigInt   @map("album_id")
  role          UserRole @default(member)
  childRelation String   @db.VarChar(20) @map("child_relation")
  nickname      String   @db.VarChar(50)
  joinedAt      DateTime @default(now()) @db.Timestamptz @map("joined_at")
  createdAt     DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt     DateTime @default(now()) @db.Timestamptz @map("updated_at")

  user  RUsers  @relation("UserAlbums", fields: [userId], references: [userId], onDelete: Cascade)
  album RAlbums @relation("AlbumUsers", fields: [albumId], references: [albumId], onDelete: Cascade)

  @@unique([userId, albumId], map: "idx_users_albums_user_album")
  @@map("r_users_albums")
}

model ENews {
  newsId    BigInt   @id @default(autoincrement()) @map("news_id")
  albumId   BigInt   @map("album_id")
  newsType  NewsType @map("news_type") // Enum名を修正
  createdAt DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt DateTime @default(now()) @db.Timestamptz @map("updated_at")

  album RAlbums @relation(fields: [albumId], references: [albumId])

  upload  EUploads?  @relation("NewsUpload")
  comment EComments? @relation("NewsComment")

  @@map("e_news")
}

model EUploads {
  uploadId    BigInt   @id @map("upload_id") // 1:1関係 (ENewsのPKを共有)
  uploaderId  BigInt   @map("uploader_id")
  photoCount  BigInt   @default(0) @map("photo_count")
  videoCount  BigInt   @default(0) @map("video_count")
  createdAt   DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt   DateTime @default(now()) @db.Timestamptz @map("updated_at")

  news      ENews     @relation("NewsUpload", fields: [uploadId], references: [newsId], onDelete: Cascade)
  uploader  RUsers    @relation("UserUploads", fields: [uploaderId], references: [userId])
  contents  RContents[]

  @@map("e_uploads")
}

model RContents {
  contentId     BigInt      @id @default(autoincrement()) @map("content_id")
  albumId       BigInt      @map("album_id")
  uploadId      BigInt      @map("upload_id")
  contentType   ContentType @map("content_type")
  contentHash   String      @unique @db.Char(64) @map("content_hash")
  uri           String?     @unique
  storageKey    String      @unique @map("storage_key")
  caption       String?
  takenAt       DateTime?   @db.Timestamptz @map("taken_at")
  createdAt     DateTime    @default(now()) @db.Timestamptz @map("created_at")
  updatedAt     DateTime    @default(now()) @db.Timestamptz @map("updated_at")

  album    RAlbums   @relation(fields: [albumId], references: [albumId])
  upload   EUploads  @relation(fields: [uploadId], references: [uploadId])
  photo    RPhotos?
  video    RVideos?
  comments EComments[]

  @@map("r_contents")
}

model RPhotos {
  photoId   BigInt   @id @map("photo_id") // 1:1関係 (RContentsのPKを共有)
  width     BigInt
  height    BigInt
  exif      Json?
  createdAt DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt DateTime @default(now()) @db.Timestamptz @map("updated_at")

  // リレーションフィールド名変更
  content RContents @relation(fields: [photoId], references: [contentId], onDelete: Cascade)

  @@map("r_photos")
}

model RVideos {
  videoId         BigInt   @id @map("video_id") // 1:1関係 (RContentsのPKを共有)
  durationSeconds BigInt   @map("duration_seconds")
  metadata        Json?
  createdAt       DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt       DateTime @default(now()) @db.Timestamptz @map("updated_at")

  // リレーションフィールド名変更
  content RContents @relation(fields: [videoId], references: [contentId], onDelete: Cascade)

  @@map("r_videos")
}

model EComments {
  commentId BigInt   @id @map("comment_id") // 1:1関係 (ENewsのPKを共有)
  contentId BigInt   @map("content_id")
  authorId  BigInt?  @map("author_id")
  body      String
  postedAt  DateTime @default(now()) @db.Timestamptz @map("posted_at")
  editedAt  DateTime @default(now()) @db.Timestamptz @map("edited_at")
  createdAt DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt DateTime @default(now()) @db.Timestamptz @map("updated_at")

  news    ENews     @relation("NewsComment", fields: [commentId], references: [newsId], onDelete: Cascade)
  content RContents @relation(fields: [contentId], references: [contentId], onDelete: Cascade)
  author  RUsers?   @relation("AuthorComments", fields: [authorId], references: [userId], onDelete: SetNull)

  @@map("e_comments")
}

model RChildren {
  childId   BigInt    @id @default(autoincrement()) @map("child_id")
  albumId   BigInt    @map("album_id")
  name      String
  birthday  DateTime? @db.Date
  genderId  BigInt    @map("gender_id")
  createdAt DateTime  @default(now()) @db.Timestamptz @map("created_at")
  updatedAt DateTime  @default(now()) @db.Timestamptz @map("updated_at")

  album  RAlbums @relation(fields: [albumId], references: [albumId])
  gender RGender @relation("GenderChildren", fields: [genderId], references: [genderId])

  @@map("r_children")
}

model EUploadSessions {
  uploadSessionId     BigInt   @id @default(autoincrement()) @map("upload_session_id")
  objectKey           String   @unique @map("object_key")
  uploadStatus        UploadStatus @default(pending) @map("upload_status")
  expectedContentType String?  @map("expected_content_type")
  maxBytes            Int?     @map("max_bytes")
  presignedUrl        String   @map("presigned_url")
  expiresAt           DateTime @db.Timestamptz @map("expires_at")
  createdAt           DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt           DateTime @default(now()) @db.Timestamptz @map("updated_at")

  @@map("e_upload_sessions")
}
