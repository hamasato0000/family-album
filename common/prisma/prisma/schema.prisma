generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums ---
enum ContentType {
  image
  video

  @@map("content_type")
}

enum UserRole {
  owner
  admin
  member

  @@map("user_role")
}

enum ActivityType {
  upload
  comment

  @@map("activity_type")
}

// pending: 署名付きURL発行済、アップロード待ち
// processing: 処理中
// completed: 処理完了
// failed: 処理失敗
// expired: 有効期限切れ
enum UploadStatus {
  pending
  processing
  completed
  failed
  expired

  @@map("upload_status")
}

// --- Models ---
// モデル名を PascalCase、テーブル名を @@map で指定
// フィールド名を camelCase、カラム名を @map で指定
// リレーションフィールド名からプレフィックスを除去

model RGender {
  genderId   BigInt   @id @default(autoincrement()) @map("gender_id")
  genderName String   @map("gender_name") @db.VarChar(10)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @default(now()) @map("updated_at") @db.Timestamptz

  children RChild[] @relation("GenderChildren")

  @@map("r_gender")
}

model RUser {
  userId      BigInt   @id @default(autoincrement()) @map("user_id")
  idpUserId   String   @unique @map("idp_user_id")
  email       String   @unique @db.Citext
  displayName String   @map("display_name")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz

  userAlbums RUserAlbum[] @relation("UserAlbums")
  uploads    EUpload[]    @relation("UserUploads")
  comments   EComment[]   @relation("AuthorComments")

  @@map("r_user")
}

model RAlbum {
  albumId   String   @id @map("album_id") @db.Char(12)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz

  userAlbums RUserAlbum[] @relation("AlbumUsers")
  activities EActivity[]
  children   RChild[]
  contents   RContent[]

  @@map("r_album")
}

model RChildRelation {
  childRelationId BigInt   @id @default(autoincrement()) @map("child_relation_id")
  relationName    String   @map("relation_name") @db.VarChar(20)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @default(now()) @map("updated_at") @db.Timestamptz

  @@map("r_child_relation")
}

model RUserAlbum {
  userAlbumId   BigInt   @id @default(autoincrement()) @map("user_album_id")
  userId        BigInt   @map("user_id")
  albumId       String   @map("album_id") @db.Char(12)
  role          UserRole @default(member)
  childRelation String   @map("child_relation") @db.VarChar(20)
  nickname      String   @db.VarChar(50)
  joinedAt      DateTime @default(now()) @map("joined_at") @db.Timestamptz
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @map("updated_at") @db.Timestamptz

  user  RUser  @relation("UserAlbums", fields: [userId], references: [userId], onDelete: Cascade)
  album RAlbum @relation("AlbumUsers", fields: [albumId], references: [albumId], onDelete: Cascade)

  @@unique([userId, albumId], map: "idx_user_album_user_album")
  @@map("r_user_album")
}

model EActivity {
  activityId   String       @id @map("activity_id") @db.Char(12)
  albumId      String       @map("album_id") @db.Char(12)
  activityType ActivityType @map("activity_type")
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime     @default(now()) @map("updated_at") @db.Timestamptz

  album RAlbum @relation(fields: [albumId], references: [albumId])

  upload  EUpload?  @relation("ActivityUpload")
  comment EComment? @relation("ActivityComment")

  @@map("e_activity")
}

model EUpload {
  uploadId   String       @id @map("upload_id") @db.Char(12)
  uploaderId BigInt       @map("uploader_id")
  photoCount BigInt       @default(0) @map("photo_count")
  videoCount BigInt       @default(0) @map("video_count")
  status     UploadStatus @default(pending)
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime     @default(now()) @map("updated_at") @db.Timestamptz

  activity EActivity  @relation("ActivityUpload", fields: [uploadId], references: [activityId], onDelete: Cascade)
  uploader RUser      @relation("UserUploads", fields: [uploaderId], references: [userId])
  contents RContent[]

  @@map("e_upload")
}

model RContent {
  contentId     String      @id @map("content_id") @db.Char(12)
  albumId       String      @map("album_id") @db.Char(12)
  uploadId      String      @map("upload_id") @db.Char(12)
  contentType   ContentType @map("content_type")
  contentHash   String      @unique @map("content_hash") @db.Char(64)
  rawPath       String      @unique @map("raw_path")
  thumbnailPath String?     @unique @map("thumbnail_path")
  fileSize      BigInt?     @map("file_size")
  caption       String?
  errorMessage  String?     @map("error_message")
  takenAt       DateTime?   @map("taken_at") @db.Timestamptz
  processedAt   DateTime?   @map("processed_at") @db.Timestamptz
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime    @default(now()) @map("updated_at") @db.Timestamptz

  album    RAlbum     @relation(fields: [albumId], references: [albumId])
  upload   EUpload    @relation(fields: [uploadId], references: [uploadId])
  photo    RPhoto?
  video    RVideo?
  comments EComment[]

  @@map("r_content")
}

model RPhoto {
  photoId   String   @id @map("photo_id") @db.Char(12)
  width     BigInt
  height    BigInt
  exif      Json?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz

  content RContent @relation(fields: [photoId], references: [contentId], onDelete: Cascade)

  @@map("r_photo")
}

model RVideo {
  videoId         String   @id @map("video_id") @db.Char(12)
  durationSeconds BigInt   @map("duration_seconds")
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @default(now()) @map("updated_at") @db.Timestamptz

  content RContent @relation(fields: [videoId], references: [contentId], onDelete: Cascade)

  @@map("r_video")
}

model EComment {
  commentId String   @id @map("comment_id") @db.Char(12)
  contentId String   @map("content_id") @db.Char(12)
  authorId  BigInt?  @map("author_id")
  body      String
  postedAt  DateTime @default(now()) @map("posted_at") @db.Timestamptz
  editedAt  DateTime @default(now()) @map("edited_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz

  activity EActivity @relation("ActivityComment", fields: [commentId], references: [activityId], onDelete: Cascade)
  content  RContent  @relation(fields: [contentId], references: [contentId], onDelete: Cascade)
  author   RUser?    @relation("AuthorComments", fields: [authorId], references: [userId], onDelete: SetNull)

  @@map("e_comment")
}

model RChild {
  childId   String    @id @map("child_id") @db.Char(12)
  albumId   String    @map("album_id") @db.Char(12)
  name      String
  birthday  DateTime? @db.Date
  genderId  BigInt    @map("gender_id")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @default(now()) @map("updated_at") @db.Timestamptz

  album  RAlbum  @relation(fields: [albumId], references: [albumId])
  gender RGender @relation("GenderChildren", fields: [genderId], references: [genderId])

  @@map("r_child")
}
