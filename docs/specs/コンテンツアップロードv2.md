## API設計

### 共通仕様

- ベースURL: `https://api.example.com/v1`
- 認証: Authorization: Bearer {access_token}
- Content-Type: application/json

### 1. アップロード開始API

アップロードを作成し、upload_idを返却する。

**エンドポイント:** `POST /uploads`

**リクエスト:**
```json
{
  "content_count": 3
}
```

**レスポンス（201 Created）:**
```json
{
  "upload_id": "V1StGXR8_Z5j",
  "status": "pending",
  "content_count": 3,
  "created_at": "2025-02-03T10:00:00Z"
}
```

**処理内容:**
1. リクエストバリデーション（content_count > 0）
2. uploadsレコード作成（status=pending）
3. レスポンス返却

**エラー:**
- 400: content_countが不正
- 401: 認証エラー

---

### 2. 署名付きURL生成API

コンテンツごとの署名付きURLを一括生成する。

**エンドポイント:** `POST /uploads/{upload_id}/contents`

**リクエスト:**
```json
{
  "contents": [
    {
      "filename": "photo1.jpg",
      "content_type": "image/jpeg"
    },
    {
      "filename": "photo2.png",
      "content_type": "image/png"
    }
  ]
}
```

**レスポンス（201 Created）:**
```json
{
  "contents": [
    {
      "content_id": "IRFa-VaY2b3k",
      "presigned_url": "https://bucket.s3.amazonaws.com/raws/V1StGXR8_Z5j/IRFa-VaY2b3k.jpg?...",
      "expires_in": 3600
    },
    {
      "content_id": "Hk9xPqW3mN7v",
      "presigned_url": "https://bucket.s3.amazonaws.com/raws/V1StGXR8_Z5j/Hk9xPqW3mN7v.png?...",
      "expires_in": 3600
    }
  ]
}
```

**処理内容:**
1. upload_idの存在確認・所有者確認
2. 各コンテンツについて:
   - content_id生成（UUID）
   - contentsレコード作成（status=pending）
   - S3署名付きURL生成（PUT用、有効期限1時間）
3. レスポンス返却

**バリデーション:**
- content_typeは `image/jpeg`, `image/png`, のみ許可
- 1リクエストあたり最大20枚
- upload_idに紐づくコンテンツ数がcontent_countを超えないこと

**エラー:**
- 400: バリデーションエラー
- 401: 認証エラー
- 403: upload_idの所有者でない
- 404: upload_idが存在しない

---

### 3. アップロード状態確認API

アップロードと配下のコンテンツの状態を取得する。

**エンドポイント:** `GET /uploads/{upload_id}`

**レスポンス（200 OK）:**
```json
{
  "upload_id": "V1StGXR8_Z5j",
  "status": "completed",
  "content_count": 3,
  "created_at": "2025-02-03T10:00:00Z",
  "completed_at": "2025-02-03T10:01:30Z",
  "contents": [
    {
      "content_id": "IRFa-VaY2b3k",
      "original_filename": "photo1.jpg",
      "status": "completed",
      "thumbnail_url": "https://cdn.example.com/thumbnails/V1StGXR8_Z5j/IRFa-VaY2b3k.jpg",
      "raw_url": "https://cdn.example.com/raws/V1StGXR8_Z5j/IRFa-VaY2b3k.jpg",
      "width": 1920,
      "height": 1080,
      "file_size": 2048000
    },
    {
      "content_id": "Hk9xPqW3mN7v",
      "original_filename": "photo2.png",
      "status": "failed",
      "error_message": "Unsupported image format"
    }
  ],
  "summary": {
    "pending": 0,
    "processing": 0,
    "completed": 2,
    "failed": 1
  }
}
```

**エラー:**
- 401: 認証エラー
- 403: upload_idの所有者でない
- 404: upload_idが存在しない

---

## コンテンツ処理仕様

### トリガー

- イベントソース: S3
- イベントタイプ: `s3:ObjectCreated:*`
- プレフィックス: `raws/`

### 処理フロー

```
1. S3イベントからオブジェクトキーを取得
2. キーからupload_idとcontent_idを抽出
3. contentsレコードをstatus=processingに更新
4. 画像検証
   - フォーマット検証（JPEG/PNG）
   - 破損チェック
   - 最大サイズチェック（例: 50MB）
5. 検証失敗時:
   - contentsをstatus=failed、error_messageを記録
   - 完了判定処理へ
6. 検証成功時:
   - 画像メタデータ取得（width, height, file_size）
   - EXIF情報から撮影日時を取得（存在する場合）
   - サムネイル生成（例: 長辺400px）
   - サムネイルをS3に保存（/thumbnails/{upload_id}/{content_id}.{ext}）
   - contentsレコード更新:
     - thumbnail_path
     - width, height, file_size
     - taken_at（EXIF撮影日時、なければNULL）
     - status=completed
     - processed_at
7. 完了判定処理:
   - upload_id配下のcontentsで completed + failed の件数を取得
   - 件数 == uploads.content_count の場合:
     - uploads.status = completed
     - uploads.completed_at = NOW()
```