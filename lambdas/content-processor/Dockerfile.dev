# syntax=docker/dockerfile:1

# Lambda の実行環境に寄せた build 環境
FROM public.ecr.aws/sam/build-nodejs22.x:latest AS build

WORKDIR /app

# 依存解決だけ先に（キャッシュを効かせる）
COPY package*.json ./
COPY common/*/package*.json ./common/
COPY lambdas/content-processor/package*.json ./lambdas/content-processor/

# Lambda パッケージの依存を入れる
ARG LAMBDA_WORKSPACE=@family-album/content-processor
ARG PRISMA_WORKSPACE=@family-album/prisma

RUN npm ci --include-workspace-root \
    --workspace=${LAMBDA_WORKSPACE} \
    --workspace=${PRISMA_WORKSPACE}

# ソースをコピー
COPY . .

# Prisma Client 生成（schema は @family-album/prisma の package.json の prisma.schema を使う）
RUN npm run generate -w ${PRISMA_WORKSPACE}

# Lambda のビルド（TypeScript なら dist を作る想定）
RUN npm run build -w ${LAMBDA_WORKSPACE}

# 実行に不要な devDependencies を削る
RUN npm prune --omit=dev --workspaces --include-workspace-root

# 実行ステージ（Lambda 公式ベースイメージ）
FROM public.ecr.aws/lambda/nodejs:22 AS runtime
# Lambda ベースイメージの作業ディレクトリは /var/task
WORKDIR /var/task

# ワークスペースの symlink を壊さないように、リポジトリ構造を保ってコピー
COPY --from=build /app/node_modules ./node_modules
COPY --from=build /app/common ./common
COPY --from=build /app/lambdas/content-processor ./lambdas/content-processor
COPY --from=build /app/package.json ./package.json
COPY --from=build /app/package-lock.json ./package-lock.json

CMD ["lambdas/content-processor/dist/handler.handler"]