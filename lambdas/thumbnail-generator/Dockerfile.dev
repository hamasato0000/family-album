# syntax=docker/dockerfile:1

# Lambda の実行環境に寄せた build 環境
FROM public.ecr.aws/sam/build-nodejs22.x:latest AS build

WORKDIR /app

# 依存解決だけ先に（キャッシュを効かせる）
COPY package*.json ./
COPY lambdas/thumbnail-generator/package*.json ./lambdas/thumbnail-generator/

# Lambda パッケージの依存を入れる
ARG LAMBDA_WORKSPACE=@family-album/thumbnail-generator

RUN npm ci --include-workspace-root \
    --workspace=${LAMBDA_WORKSPACE}

# ソースをコピー
COPY . .

# Lambda のビルド（Docker内ではtscを使用）
RUN cd lambdas/thumbnail-generator && npx tsc -p .

# 実行に不要な devDependencies を削る
RUN npm prune --omit=dev --workspaces --include-workspace-root


# 実行ステージ（Lambda 公式ベースイメージ）
FROM public.ecr.aws/lambda/nodejs:22 AS runtime
# Lambda ベースイメージの作業ディレクトリは /var/task
WORKDIR /var/task

# ワークスペースの symlink を壊さないように、リポジトリ構造を保ってコピー
COPY --from=build /app/node_modules ./node_modules
COPY --from=build /app/lambdas/thumbnail-generator ./lambdas/thumbnail-generator
COPY --from=build /app/package.json ./package.json
COPY --from=build /app/package-lock.json ./package-lock.json

# ここはあなたの Lambda ハンドラに合わせて変更してください
# 例: lambda/dist/handler.js が exports.handler を持つならこれ
CMD ["lambdas/thumbnail-generator/dist/handler.handler"]
