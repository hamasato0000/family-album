# syntax=docker/dockerfile:1

# Lambda の実行環境に寄せた build 環境（Prisma のネイティブバイナリ対策）
# SAM build image は Lambda 実行環境に近いツールチェーンを含む
FROM public.ecr.aws/sam/build-nodejs22.x:latest AS build

WORKDIR /app

# 依存解決だけ先に（キャッシュを効かせる）
COPY package*.json ./
COPY common/*/package*.json ./common/
COPY lambdas/upload-content-verifier/package*.json ./lambdas/upload-content-verifier/

# Lambda と Prisma パッケージの依存を入れる（Prisma CLI が common/prisma の devDeps にいる想定）
ARG LAMBDA_WORKSPACE=@family-album/upload-content-verifier
ARG PRISMA_WORKSPACE=@family-album/prisma

RUN npm ci --include-workspace-root \
  --workspace=${LAMBDA_WORKSPACE} \
  --workspace=${PRISMA_WORKSPACE}

# ソースをコピー
COPY . .

# Prisma Client 生成（schema は @family-album/prisma の package.json の prisma.schema を使う）
RUN npm run generate -w ${PRISMA_WORKSPACE}

# Lambda のビルド（TypeScript なら dist を作る想定）
RUN npm run build -w ${LAMBDA_WORKSPACE}

# 実行に不要な devDependencies を削る（生成済み Prisma Client は残る）
RUN npm prune --omit=dev --workspaces --include-workspace-root


# 実行ステージ（Lambda 公式ベースイメージ）
FROM public.ecr.aws/lambda/nodejs:22 AS runtime
# Lambda ベースイメージの作業ディレクトリは /var/task
WORKDIR /var/task

# ワークスペースの symlink を壊さないように、リポジトリ構造を保ってコピー
COPY --from=build /app/node_modules ./node_modules
COPY --from=build /app/common ./common
COPY --from=build /app/lambdas/upload-content-verifier ./lambdas/upload-content-verifier
COPY --from=build /app/package.json ./package.json
COPY --from=build /app/package-lock.json ./package-lock.json

# ここはあなたの Lambda ハンドラに合わせて変更してください
# 例: lambda/dist/handler.js が exports.handler を持つならこれ
CMD ["lambdas/upload-content-verifier/dist/handler.handler"]
